// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enums
enum UserRole {
  USER
  PARTNER
  ADMIN
  SUPER_ADMIN
}

enum Gender {
  MALE
  FEMALE
  OTHER
  PREFER_NOT_TO_SAY
}

enum ActivityLevel {
  SEDENTARY
  LIGHT
  MODERATE
  ACTIVE
  VERY_ACTIVE
}

enum EventType {
  WORKOUT
  MEDITATION
  PRAYER
  STUDY
  SERVICE
  OTHER
}

enum EventCategory {
  FITNESS
  SPIRITUAL
  HYBRID
}

enum MoodLevel {
  VERY_LOW
  LOW
  NEUTRAL
  GOOD
  VERY_GOOD
}

enum EnergyLevel {
  VERY_LOW
  LOW
  MODERATE
  HIGH
  VERY_HIGH
}

enum PartnerType {
  GYM
  STUDIO
  CHURCH
  NONPROFIT
  RETAILER
  SERVICE
}

enum PartnerStatus {
  PENDING
  APPROVED
  REJECTED
  SUSPENDED
  ACTIVE
}

enum OfferType {
  DISCOUNT
  FREE_TRIAL
  EXCLUSIVE_ACCESS
  MERCHANDISE
  SERVICE
}

enum RewardType {
  ACTIVITY
  STREAK
  MILESTONE
  PARTNER_REFERRAL
  MANUAL
}

enum RewardStatus {
  PENDING
  APPROVED
  CLAIMED
  EXPIRED
  REJECTED
}

enum JobStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
  RETRYING
}

enum MintRequestStatus {
  QUEUED
  ADMIN_REVIEW
  APPROVED
  REJECTED
  MINTING
  COMPLETED
  FAILED
}

enum WalletVerificationStatus {
  PENDING
  VERIFIED
  REJECTED
  EXPIRED
}

enum StreakType {
  DAILY
  WEEKLY
  MONTHLY
}

enum NotificationType {
  REWARD
  STREAK
  PARTNER
  MILESTONE
  SOCIAL
  SYSTEM
}

enum TransactionType {
  REWARD
  CLAIM
  TRANSFER
  STAKE
  UNSTAKE
}

enum TransactionStatus {
  PENDING
  CONFIRMED
  FAILED
  CANCELLED
}

enum AIMessageType {
  DAILY_MOTIVATION
  STREAK_ENCOURAGEMENT
  MILESTONE_CELEBRATION
  PARTNER_RECOMMENDATION
}

// Human Accountability System Enums
enum PartnershipStatus {
  REQUESTED
  PENDING
  ACCEPTED
  REJECTED
  PAUSED
  ENDED
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  REQUIRES_CLARIFICATION
}

enum PlanType {
  SPIRITUAL
  WORKOUT
  HYBRID
}

enum PlanStatus {
  DRAFT
  ACTIVE
  PAUSED
  COMPLETED
  ARCHIVED
}

// Main Models
model User {
  id            String   @id @default(uuid())
  email         String   @unique
  username      String   @unique
  firstName     String?
  lastName      String?
  avatar        String?
  passwordHash  String
  walletAddress String?  @unique
  walletConnectedAt DateTime?
  walletLastVerified DateTime?
  role          UserRole @default(USER)
  isActive      Boolean  @default(true)
  emailVerified Boolean  @default(false)
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  lastLoginAt DateTime?
  
  // Relations
  profile       UserProfile?
  events        Event[]
  rewards       Reward[]
  streaks       Streak[]
  notifications Notification[]
  transactions  Transaction[]
  aiMessages    AIMessage[]
  
  // Human Accountability Relations
  partnershipRequests     PartnershipRequest[] @relation("PartnershipRequestUser")
  partnershipPartners     PartnershipRequest[] @relation("PartnershipRequestPartner")
  plans                   Plan[]
  eventApprovals          EventApproval[]
  eventApprovalsAsPartner EventApproval[] @relation("EventApprovalPartner")
  dailySummaries          DailySummary[]
  partnerNotifications    PartnerNotification[]
  walletVerifications     WalletVerification[]
  
  @@map("users")
}

model UserProfile {
  id     String @id @default(uuid())
  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Personal Information
  bio           String?
  dateOfBirth   DateTime?
  gender        Gender?
  height        Float?      // cm
  weight        Float?      // kg
  activityLevel ActivityLevel @default(MODERATE)
  timezone      String        @default("UTC")
  language      String        @default("en")
  
  // Goals
  fitnessGoals   String[] // JSON array
  spiritualGoals String[] // JSON array
  
  // Streak Tracking
  currentFitnessStreak   Int @default(0)
  longestFitnessStreak   Int @default(0)
  currentSpiritualStreak Int @default(0)
  longestSpiritualStreak Int @default(0)
  currentCombinedStreak  Int @default(0)
  longestCombinedStreak  Int @default(0)
  
  // Gamification
  level        Int   @default(1)
  experience   Int   @default(0)
  totalTokens  Int   @default(0)
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("user_profiles")
}

model Event {
  id          String        @id @default(uuid())
  userId      String
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Event Details
  type        EventType
  category    EventCategory
  title       String
  description String?
  duration    Int?          // minutes
  intensity   Int?          // 1-10 scale
  mood        MoodLevel?
  energy      EnergyLevel?
  location    String?
  notes       String?
  tags        String[]      // JSON array
  
  // Timestamps
  completedAt DateTime      @default(now())
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  
  // Fitness specific
  caloriesBurned Int?
  exercises      Exercise[]
  
  // Spiritual specific
  technique   String?
  reflection  String?
  gratitude   String[] // JSON array
  insights    String[] // JSON array
  
  // Relations
  rewards     Reward[]
  eventApproval EventApproval?
  
  @@map("events")
}

model Exercise {
  id       String @id @default(uuid())
  eventId  String
  event    Event  @relation(fields: [eventId], references: [id], onDelete: Cascade)
  
  name     String
  sets     Int?
  reps     Int?
  weight   Float? // kg
  distance Float? // meters
  duration Int?   // seconds
  
  @@map("exercises")
}

model Partner {
  id          String        @id @default(uuid())
  name        String
  email       String        @unique
  type        PartnerType
  status      PartnerStatus @default(PENDING)
  description String
  logo        String?
  website     String?
  contactPerson String
  
  // Partnership Details
  offerType          OfferType
  offerDescription   String
  tokenRequirement   Int
  maxRedemptions     Int?
  validUntil         DateTime?
  
  // Admin fields
  approvedBy String?
  approvedAt DateTime?
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  rewards   Reward[]
  
  @@map("partners")
}

model Reward {
  id        String       @id @default(uuid())
  userId    String
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  eventId   String?
  event     Event?       @relation(fields: [eventId], references: [id], onDelete: SetNull)
  partnerId String?
  partner   Partner?     @relation(fields: [partnerId], references: [id], onDelete: SetNull)
  
  // Reward Details
  type         RewardType
  amount       Int        // token amount
  reason       String
  status       RewardStatus @default(PENDING)
  
  // Metadata
  sourceType   String     // 'event' | 'streak' | 'milestone' | 'partner' | 'manual'
  multiplier   Float?
  bonusReason  String?
  
  // Timestamps
  earnedAt  DateTime  @default(now())
  claimedAt DateTime?
  expiresAt DateTime?
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  
  @@map("rewards")
}

model Streak {
  id             String      @id @default(uuid())
  userId         String
  user           User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type           StreakType
  category       EventCategory
  currentCount   Int         @default(0)
  longestCount   Int         @default(0)
  lastActiveDate DateTime
  startDate      DateTime    @default(now())
  endDate        DateTime?
  isActive       Boolean     @default(true)
  
  // Milestone tracking (JSON)
  milestones     Json        @default("[]") // Array of milestone objects
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("streaks")
}

model Notification {
  id      String           @id @default(uuid())
  userId  String
  user    User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type    NotificationType
  title   String
  message String
  data    Json?            // Additional data
  
  // Timestamps
  readAt    DateTime?
  createdAt DateTime        @default(now())
  
  @@map("notifications")
}

model Transaction {
  id          String            @id @default(uuid())
  userId      String
  user        User              @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type        TransactionType
  amount      Int
  fromAddress String?
  toAddress   String?
  signature   String?           // Blockchain transaction signature
  status      TransactionStatus @default(PENDING)
  
  // Timestamps
  createdAt   DateTime          @default(now())
  confirmedAt DateTime?
  
  @@map("transactions")
}

model AIMessage {
  id        String        @id @default(uuid())
  userId    String
  user      User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  type      AIMessageType
  content   String
  context   Json?         // Additional context for message generation
  
  // Timestamps
  generatedAt DateTime     @default(now())
  sentAt      DateTime?
  readAt      DateTime?
  
  @@map("ai_messages")
}

model AIPromptTemplate {
  id        String   @id @default(uuid())
  name      String
  category  String
  template  String
  variables String[] // JSON array of variable names
  isActive  Boolean  @default(true)
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("ai_prompt_templates")
}

// Additional utility models for system management

model SystemConfig {
  id    String @id @default(uuid())
  key   String @unique
  value String
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("system_config")
}

model AuditLog {
  id        String   @id @default(uuid())
  userId    String?  // null for system actions
  action    String
  resource  String
  resourceId String?
  details   Json?
  ipAddress String?
  userAgent String?
  
  // Timestamps
  createdAt DateTime @default(now())
  
  @@map("audit_logs")
}

// Human Accountability System Models

model PartnershipRequest {
  id        String            @id @default(uuid())
  userId    String
  user      User              @relation("PartnershipRequestUser", fields: [userId], references: [id], onDelete: Cascade)
  partnerId String?
  partner   User?             @relation("PartnershipRequestPartner", fields: [partnerId], references: [id], onDelete: SetNull)
  
  status    PartnershipStatus @default(REQUESTED)
  message   String?           // Optional message with request
  
  // Partnership settings
  allowsEventReview Boolean @default(true)   // Can partner review/approve events
  allowsPlanCreation Boolean @default(true)  // Can partner create plans for user
  allowsGoalSetting Boolean @default(true)   // Can partner set/modify goals
  
  // Auto-matching fields (when no specific partner requested)
  preferredGender     Gender?
  preferredAgeRange   String?      // e.g., "25-35"
  preferredExperience String?      // e.g., "beginner", "intermediate", "advanced"
  preferredCategories EventCategory[] // Areas where they want accountability
  
  // Response from partner
  partnerResponse String?
  responseAt      DateTime?
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  acceptedAt DateTime?
  endedAt    DateTime?
  
  @@map("partnership_requests")
}

model Plan {
  id          String     @id @default(uuid())
  createdBy   String     // Partner who created the plan
  creator     User       @relation(fields: [createdBy], references: [id], onDelete: Cascade)
  
  // Plan details
  type        PlanType
  title       String
  description String?
  status      PlanStatus @default(DRAFT)
  
  // Schedule and targets
  startDate   DateTime
  endDate     DateTime?
  weeklyGoal  Int?       // Number of activities per week
  
  // Plan content (JSON structure for flexibility)
  activities  Json       // Array of planned activities with schedules
  goals       Json       // Specific measurable goals
  milestones  Json       // Checkpoint milestones and rewards
  
  // Tracking
  completedActivities Int @default(0)
  totalActivities     Int @default(0)
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("plans")
}

model EventApproval {
  id       String        @id @default(uuid())
  eventId  String        @unique
  event    Event         @relation(fields: [eventId], references: [id], onDelete: Cascade)
  userId   String
  user     User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  partnerId String?
  partner  User?         @relation("EventApprovalPartner", fields: [partnerId], references: [id], onDelete: SetNull)
  
  status   ApprovalStatus @default(PENDING)
  
  // Approval details
  partnerFeedback String?   // Partner's feedback on the activity
  partnerRating   Int?      // 1-5 rating from partner
  clarificationNeeded String? // What needs clarification
  
  // AI-generated summary for partner review
  aiSummary String?
  
  // Reward multiplier if approved
  approvalMultiplier Float? @default(1.5) // 50% bonus for partner-approved events
  
  // Timestamps
  submittedAt DateTime @default(now())
  reviewedAt  DateTime?
  
  @@map("event_approvals")
}

model DailySummary {
  id     String @id @default(uuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  date   DateTime @db.Date
  
  // AI-generated summary content
  adherenceBullet     String  // How well they stuck to their plan
  highlightsBullet    String  // Key achievements/notable moments
  recommendationBullet String // Suggestion for improvement/next steps
  
  // Metrics
  activitiesCompleted Int @default(0)
  activitiesPlanned   Int @default(0)
  totalDuration      Int @default(0) // minutes
  avgMood            Float?
  avgEnergy          Float?
  
  // Partner engagement
  partnerNotified Boolean @default(false)
  partnerViewed   Boolean @default(false)
  partnerViewedAt DateTime?
  
  // Timestamps
  generatedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([userId, date])
  @@map("daily_summaries")
}

model PartnerNotification {
  id         String @id @default(uuid())
  partnerId  String
  partner    User   @relation(fields: [partnerId], references: [id], onDelete: Cascade)
  
  type       String // "approval_needed", "daily_summary", "plan_milestone", etc.
  title      String
  message    String
  data       Json?  // Additional structured data
  
  // Email/webhook delivery
  emailSent    Boolean @default(false)
  webhookSent  Boolean @default(false)
  deliveredAt  DateTime?
  
  // User interaction
  readAt       DateTime?
  actionTaken  String? // What action the partner took
  
  // Timestamps
  createdAt DateTime @default(now())
  
  @@map("partner_notifications")
}

// Reward Engine Models

model RewardRule {
  id          String @id @default(uuid())
  name        String @unique
  description String
  isActive    Boolean @default(true)
  priority    Int @default(0) // Higher priority rules are processed first
  
  // Rule conditions (JSON structure for flexibility)
  conditions Json // { eventType?, category?, duration?, intensity?, streakCount?, etc. }
  
  // Reward calculation
  baseAmount      Int   // Base token amount
  multiplierRules Json? // Additional multiplier conditions
  maxDailyAmount  Int?  // Daily cap for this rule
  maxUserAmount   Int?  // Per-user total cap
  
  // Time constraints
  validFrom DateTime?
  validTo   DateTime?
  
  // Metadata
  version   String @default("1.0")
  createdBy String? // Admin who created the rule
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("reward_rules")
}

model RewardJob {
  id       String @id @default(uuid())
  jobId    String @unique // BullMQ job ID
  status   JobStatus @default(PENDING)
  
  // Job data
  userId   String
  eventId  String?
  type     RewardType
  
  // Processing results
  tokensEarned    Int?
  rulesApplied    Json? // Array of rules that were applied
  errorMessage    String?
  retryCount      Int @default(0)
  maxRetries      Int @default(3)
  
  // Processing metadata
  processedAt DateTime?
  scheduledFor DateTime @default(now())
  
  // Timestamps
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("reward_jobs")
}

model MintRequest {
  id              String @id @default(uuid())
  userId          String
  status          MintRequestStatus @default(QUEUED)
  
  // Mint details
  tokenAmount     Int
  recipientWallet String
  description     String
  
  // Source tracking
  rewardIds       String[] // Array of reward IDs being claimed
  batchId         String?  // Group related mint requests
  
  // Admin review
  reviewedBy      String?
  reviewNotes     String?
  reviewedAt      DateTime?
  
  // Blockchain execution
  mintSignature   String? // Solana transaction signature
  mintedAt        DateTime?
  explorerUrl     String?
  
  // Security and audit
  ipAddress       String?
  userAgent       String?
  riskScore       Float? // 0-1 risk assessment
  
  // Timestamps
  requestedAt DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("mint_requests")
}

model RewardAudit {
  id        String @id @default(uuid())
  userId    String
  
  // Audit details
  action    String // "rule_created", "reward_processed", "mint_requested", etc.
  resource  String // "reward", "mint_request", "reward_rule"
  resourceId String
  
  // Change tracking
  oldValues Json?
  newValues Json?
  
  // Context
  triggeredBy   String? // User ID or "system"
  reason        String?
  metadata      Json?
  
  // System info
  ipAddress     String?
  userAgent     String?
  
  // Timestamps
  createdAt DateTime @default(now())
  
  @@map("reward_audits")
}

model SystemMetrics {
  id        String @id @default(uuid())
  metricKey String
  value     Float
  unit      String?
  tags      Json? // Additional metadata tags
  
  // Timestamps
  recordedAt DateTime @default(now())
  
  @@index([metricKey, recordedAt])
  @@map("system_metrics")
}

// Wallet Connection and Verification Models

model WalletVerification {
  id          String @id @default(uuid())
  userId      String
  user        User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Verification details
  publicKey   String // Solana wallet public key
  nonce       String // Random challenge nonce
  signature   String? // User's signature of the nonce
  message     String // Full message that was signed
  status      WalletVerificationStatus @default(PENDING)
  
  // Security tracking
  ipAddress   String?
  userAgent   String?
  
  // Timestamps
  createdAt   DateTime @default(now())
  verifiedAt  DateTime?
  expiresAt   DateTime // Verification challenges expire after 15 minutes
  
  @@index([userId])
  @@index([publicKey])
  @@index([nonce])
  @@index([expiresAt])
  @@map("wallet_verifications")
}

model WalletAudit {
  id          String @id @default(uuid())
  userId      String
  
  // Audit details
  action      String // "connection_attempt", "verification_success", "disconnection", etc.
  publicKey   String
  oldPublicKey String? // Previous wallet if changing
  
  // Context
  ipAddress   String?
  userAgent   String?
  metadata    Json? // Additional context data
  
  // Security flags
  suspicious  Boolean @default(false)
  reason      String? // Why flagged as suspicious
  
  // Timestamps
  createdAt   DateTime @default(now())
  
  @@index([userId])
  @@index([publicKey])
  @@index([createdAt])
  @@map("wallet_audits")
}